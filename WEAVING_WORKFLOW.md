# 🔄 Workflow Модуля Ткачества

## Схема производственного процесса

```
┌─────────────────────────────────────────────────────────────┐
│                  СКЛАД НИТИ (Экструзия)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                   │
│  │ Партия 1 │  │ Партия 2 │  │ Партия 3 │  ...              │
│  │  PP-800D │  │  PP-800D │  │PP-800D-G │                   │
│  │  250 кг  │  │  180 кг  │  │  320 кг  │                   │
│  └──────────┘  └──────────┘  └──────────┘                   │
└─────────────────────────────────────────────────────────────┘
           │                    │                    │
           │  Выбор партии      │                    │
           ▼                    ▼                    ▼
┌─────────────────────────────────────────────────────────────┐
│              ЖУРНАЛ ПРОИЗВОДСТВА ТКАЧЕСТВА                   │
│                                                              │
│  📋 Новая смена:                                             │
│  ┌────────────────────────────────────────────────┐         │
│  │ Дата: 21.01.2026                               │         │
│  │ Смена: День                                    │         │
│  │ Станок: Sulzer #1                              │         │
│  │ Оператор: Сейтжанов Ерлан                      │         │
│  │                                                │         │
│  │ Ткань: TK-105-WHITE (105 см, белая)            │         │
│  │   ├─ Уток: PP-800D (норма 0.085 кг/м)         │         │
│  │   └─ Основа: PP-800D (норма 0.065 кг/м)       │         │
│  │                                                │         │
│  │ Партия утка: 250126-1 (250 кг)                │         │
│  │ Партия основы: 250126-1 (250 кг)              │         │
│  │                                                │         │
│  │ Произведено: 1000 м, 150 кг                    │         │
│  │ Брак: 5 м                                      │         │
│  │                                                │         │
│  │ Статус рулона: ⚙️ В работе                     │         │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  💾 При сохранении:                                          │
│  ┌────────────────────────────────────────────────┐         │
│  │ ✅ Расчет расхода:                              │         │
│  │    Уток: 1000 м × 0.085 кг/м = 85 кг          │         │
│  │    Основа: 1000 м × 0.065 кг/м = 65 кг        │         │
│  │                                                │         │
│  │ ✅ Списание нити (функция SQL):                │         │
│  │    yarn_inventory ← Расход 85 кг PP-800D      │         │
│  │    yarn_inventory ← Расход 65 кг PP-800D      │         │
│  │                                                │         │
│  │ ✅ Запись документа:                            │         │
│  │    doc_number: WEAV-12345678                   │         │
│  │    roll_status: "В работе"                     │         │
│  └────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
           │
           │ Продолжение работы...
           ▼
┌─────────────────────────────────────────────────────────────┐
│         НЕЗАВЕРШЕННЫЙ РУЛОН (следующая смена)                │
│                                                              │
│  ⚠️ Блок "Незавершенные рулоны":                             │
│  ┌────────────────────────────────────────────────┐         │
│  │ 🔄 TK-105-WHITE                                 │         │
│  │    Sulzer #1 • 1000 м                          │         │
│  │                      [🔄 Продолжить]           │         │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  👆 Нажатие "Продолжить" → Автозаполнение:                  │
│  ┌────────────────────────────────────────────────┐         │
│  │ Ткань: TK-105-WHITE ✓ (из предыдущего)        │         │
│  │ Станок: Sulzer #1 ✓                            │         │
│  │ Партия утка: 250126-1 ✓                        │         │
│  │ Партия основы: 250126-1 ✓                      │         │
│  │ previous_doc_id: [ID предыдущего документа]    │         │
│  │                                                │         │
│  │ Произведено: 500 м, 75 кг (новая порция)       │         │
│  │                                                │         │
│  │ Статус рулона: ✅ Завершен                      │         │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  💾 При сохранении с статусом "Завершен":                    │
│  ┌────────────────────────────────────────────────┐         │
│  │ ✅ Расчет расхода текущей смены:                │         │
│  │    Уток: 500 × 0.085 = 42.5 кг                │         │
│  │    Основа: 500 × 0.065 = 32.5 кг              │         │
│  │                                                │         │
│  │ ✅ Накопление итогов:                           │         │
│  │    total_length = 1000 + 500 = 1500 м         │         │
│  │    total_weight = 150 + 75 = 225 кг           │         │
│  │                                                │         │
│  │ ✅ Обновление статусов цепочки:                 │         │
│  │    Все документы рулона → "Завершен"           │         │
│  │                                                │         │
│  │ ✅ Генерация номера рулона:                     │         │
│  │    ROLL-260121-4567                            │         │
│  │                                                │         │
│  │ ✅ Оприходование (функция SQL):                 │         │
│  │    fabric_inventory ← Приход рулона            │         │
│  │    1500 м, 225 кг                              │         │
│  └────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│                    СКЛАД ТКАНИ                               │
│  ┌────────────────────────────────────────────────┐         │
│  │ Рулон: ROLL-260121-4567                        │         │
│  │ Ткань: TK-105-WHITE                            │         │
│  │ Длина: 1500 м                                  │         │
│  │ Вес: 225 кг                                    │         │
│  │ Документ: WEAV-12345679                        │         │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  📊 Остатки по типам (представление):                        │
│  ┌────────────────────────────────────────────────┐         │
│  │ TK-105-WHITE:  4500 м / 675 кг                 │         │
│  │ TK-140-WHITE:  2000 м / 400 кг                 │         │
│  │ TK-105-GREEN:  1000 м / 150 кг                 │         │
│  └────────────────────────────────────────────────┘         │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔑 Ключевые моменты

### 1. Партийный учет
- Партии загружаются из модуля экструзии
- Показывается остаток по каждой партии
- При продолжении рулона партии наследуются

### 2. Цепочки документов
```
WEAV-001 (В работе)  ──┐
                       │
WEAV-002 (В работе)  ──┼─→ previous_doc_id
                       │
WEAV-003 (Завершен)  ──┘
       ↓
При завершении WEAV-003:
Все документы (001, 002, 003) → Статус "Завершен"
```

### 3. Расчет расхода
```
Формула:
  Расход = Длина × Норма_расхода_на_метр

Пример:
  Ткань: TK-105-WHITE
  Произведено: 1000 м

  Уток:   1000 м × 0.085 кг/м = 85 кг
  Основа: 1000 м × 0.065 кг/м = 65 кг

  ИТОГО: 150 кг нити → списание со склада
```

### 4. Статусы рулона
- **"В работе"**: Можно продолжить позже (не оприходуется)
- **"Завершен"**: Автоматически на склад + номер рулона

---

## 📋 Пример полного цикла

```
День 1, Смена 1:
  → Создан WEAV-001 (1000 м, В работе)
  → Списано: 85 + 65 = 150 кг нити

День 1, Смена 2:
  → Продолжен → WEAV-002 (800 м, В работе)
  → previous_doc_id = WEAV-001
  → Списано: 68 + 52 = 120 кг нити

День 2, Смена 1:
  → Продолжен → WEAV-003 (200 м, Завершен)
  → previous_doc_id = WEAV-002
  → Списано: 17 + 13 = 30 кг нити

  → Итоги рулона:
     Длина: 1000 + 800 + 200 = 2000 м
     Вес: 150 + 120 + 30 = 300 кг

  → Оприходован: ROLL-260121-0001
  → Все документы (001, 002, 003) → "Завершен"
```

---

## 🎯 Преимущества системы

1. **Точный учет** - Списание по фактическому расходу
2. **Партийность** - Полная трассировка от нити до ткани
3. **Гибкость** - Рулоны можно продолжать несколько смен
4. **Автоматизация** - Расчет и списание автоматически
5. **Контроль** - История всех операций сохраняется
