# Настройка системы авторизации

## Шаг 1: Выполните миграцию в Supabase

1. Откройте Supabase Dashboard → SQL Editor
2. Скопируйте содержимое файла `supabase/auth-setup.sql`
3. Выполните SQL запрос

## Шаг 2: Создайте первого администратора

### Вариант A: Через Supabase Dashboard

1. Перейдите в Authentication → Users
2. Нажмите "Add User"
3. Введите email и пароль
4. Подтвердите создание

5. Перейдите в SQL Editor и выполните:
```sql
SELECT set_admin_by_email('ваш-email@example.com');
```

### Вариант B: Через Supabase Admin API

Если у вас есть service role key, можно создать пользователя программно через `/api/admin/create-user`

## Шаг 3: Войдите в систему

1. Перейдите на `/login`
2. Введите email и пароль администратора
3. После входа вы попадете на главную страницу

## Шаг 4: Создайте остальных пользователей

1. Перейдите в Администрирование → Пользователи
2. Нажмите "Создать пользователя"
3. Заполните форму:
   - Email
   - Пароль
   - Привяжите к сотруднику (опционально)
   - Выберите роль

## Роли и доступ

### admin (Администратор)
- Полный доступ ко всем разделам
- Управление пользователями
- Управление сотрудниками и оборудованием

### manager (Менеджер)
- Доступ к производству
- Доступ к складу
- Доступ к отчетам
- НЕТ доступа к администрированию

### operator (Оператор)
- Доступ к производству (свой цех)
- Просмотр журналов
- НЕТ доступа к складу и отчетам

### warehouse (Кладовщик)
- Доступ к складу
- Управление остатками
- НЕТ доступа к производству

### qc (ОТК)
- Доступ к приемке ОТК
- Просмотр журналов производства
- НЕТ доступа к складу

### accountant (Бухгалтер)
- Доступ к отчетам
- Просмотр статистики
- НЕТ доступа к производству

## Проверка прав доступа в коде

```typescript
import { useAuth } from '@/lib/auth-context';

function MyComponent() {
  const { profile, isAdmin, hasRole } = useAuth();

  // Проверка на администратора
  if (!isAdmin) {
    return <div>Доступ запрещен</div>;
  }

  // Проверка на конкретную роль
  if (!hasRole('manager')) {
    return <div>Только для менеджеров</div>;
  }

  // Проверка на несколько ролей
  if (!hasRole(['admin', 'manager'])) {
    return <div>Только для администраторов и менеджеров</div>;
  }

  return <div>Контент</div>;
}
```

## Безопасность

- Все пароли хешируются Supabase Auth
- JWT токены используются для сессий
- Row Level Security (RLS) защищает данные на уровне БД
- Сессии автоматически обновляются
- Выход из системы очищает все токены

## Troubleshooting

### Ошибка "Invalid login credentials"
- Проверьте правильность email/пароля
- Убедитесь что пользователь создан в Supabase Auth
- Проверьте что email подтвержден (email_confirm: true)

### Не отображается роль пользователя
- Проверьте что таблица user_profiles создана
- Убедитесь что триггер on_auth_user_created работает
- Проверьте что VIEW user_profiles_with_employee существует

### "Access denied" при входе в админку
- Проверьте роль пользователя: `SELECT role FROM user_profiles WHERE id = 'user_id'`
- Убедитесь что is_active = true
- Проверьте RLS политики

### Бесконечный редирект на /login
- Очистите cookies и localStorage
- Проверьте что Supabase URL и anon key правильные
- Убедитесь что AuthProvider обернут вокруг приложения
