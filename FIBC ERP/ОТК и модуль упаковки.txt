/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * ĞœĞĞ”Ğ£Ğ›Ğ¬ "ĞĞ¢Ğš Ğ˜ Ğ“ĞĞ¢ĞĞ’ĞĞ¯ ĞŸĞ ĞĞ”Ğ£ĞšĞ¦Ğ˜Ğ¯"
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * FIBC Kazakhstan - Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´ÑÑ‚Ğ²Ğ¾Ğ¼
 * 
 * Ğ¤Ğ£ĞĞšĞ¦Ğ˜ĞĞĞĞ›:
 * 1. ĞŸÑ€Ğ¸ĞµĞ¼ĞºĞ° ĞĞ¢Ğš (ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğ¹)
 * 2. ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑĞ¼
 * 
 * Ğ’Ğ•Ğ Ğ¡Ğ˜Ğ¯: 1.0
 * Ğ”ĞĞ¢Ğ: 2024-12-18
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

/**
 * Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¼ĞµĞ½Ñ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ñ„Ğ°Ğ¹Ğ»Ğ°
 */
function onOpen() {
  var ui = SpreadsheetApp.getUi();
  
  ui.createMenu('ğŸ­ ĞĞ¢Ğš Ğ¸ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°Ñ ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ñ')
    .addSubMenu(ui.createMenu('âœ… ĞĞ¢Ğš (ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°)')
      .addItem('ğŸ“ ĞŸÑ€Ğ¸ĞµĞ¼ĞºĞ° ĞĞ¢Ğš', 'openQCSidebar')
      .addSeparator()
      .addItem('ğŸ“Š Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ĞĞ¢Ğš', 'openQCJournal'))
    
    .addSeparator()
    
    .addSubMenu(ui.createMenu('ğŸ“¦ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ñ')
      .addItem('ğŸšš ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»Ñ', 'openShipmentSidebar')
      .addSeparator()
      .addItem('ğŸ“Š Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ÑĞºĞ»Ğ°Ğ´Ğ°', 'openWarehouseJournal')
      .addItem('ğŸ“¦ ĞÑÑ‚Ğ°Ñ‚ĞºĞ¸ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ', 'openWarehouseBalance'))
    
    .addSeparator()
    .addItem('â„¹ï¸ Ğ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ', 'showSystemInfo')
    
    .addToUi();
}


/**
 * ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€ Ğ¿Ñ€Ğ¸ĞµĞ¼ĞºĞ¸ ĞĞ¢Ğš
 */
function openQCSidebar() {
  var html = HtmlService.createHtmlOutputFromFile('ĞĞ¢Ğš_Ğ¡Ğ°Ğ¹Ğ´Ğ±Ğ°Ñ€')
    .setTitle('âœ… ĞŸÑ€Ğ¸ĞµĞ¼ĞºĞ° ĞĞ¢Ğš')
    .setWidth(350);
  SpreadsheetApp.getUi().showSidebar(html);
}


/**
 * ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ ÑĞ°Ğ¹Ğ´Ğ±Ğ°Ñ€ Ğ¾Ñ‚Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 */
function openShipmentSidebar() {
  var html = HtmlService.createHtmlOutputFromFile('ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ°_Ğ¡Ğ°Ğ¹Ğ´Ğ±Ğ°Ñ€')
    .setTitle('ğŸ“¦ ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸')
    .setWidth(350);
  SpreadsheetApp.getUi().showSidebar(html);
}


/**
 * ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» ĞĞ¢Ğš
 */
function openQCJournal() {
  var config = getQCFinishedConfig();
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(config.SHEETS.QC_JOURNAL);
  
  if (sheet) {
    sheet.activate();
  } else {
    SpreadsheetApp.getUi().alert('Ğ›Ğ¸ÑÑ‚ "' + config.SHEETS.QC_JOURNAL + '" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!');
  }
}


/**
 * ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» ÑĞºĞ»Ğ°Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 */
function openWarehouseJournal() {
  var config = getQCFinishedConfig();
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(config.SHEETS.WAREHOUSE);
  
  if (sheet) {
    sheet.activate();
  } else {
    SpreadsheetApp.getUi().alert('Ğ›Ğ¸ÑÑ‚ "' + config.SHEETS.WAREHOUSE + '" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!');
  }
}


/**
 * ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 */
function openWarehouseBalance() {
  var config = getQCFinishedConfig();
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(config.SHEETS.BALANCE);
  
  if (sheet) {
    sheet.activate();
  } else {
    SpreadsheetApp.getUi().alert('Ğ›Ğ¸ÑÑ‚ "' + config.SHEETS.BALANCE + '" Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!');
  }
}


/**
 * ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ
 */
function showSystemInfo() {
  var message = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  message += SYSTEM_INFO.NAME + '\n';
  message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
  message += 'ĞœĞ¾Ğ´ÑƒĞ»ÑŒ: ĞĞ¢Ğš Ğ¸ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°Ñ ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ñ\n';
  message += 'Ğ’ĞµÑ€ÑĞ¸Ñ: ' + SYSTEM_INFO.VERSION + '\n';
  message += 'ĞšĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ñ: ' + SYSTEM_INFO.COMPANY + '\n';
  message += 'ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾: ' + SYSTEM_INFO.LAST_UPDATE + '\n\n';
  message += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
  message += 'Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»:\n';
  message += 'â€¢ ĞŸÑ€Ğ¸ĞµĞ¼ĞºĞ° ĞĞ¢Ğš (ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°)\n';
  message += 'â€¢ ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸\n';
  message += 'â€¢ Ğ£Ñ‡ĞµÑ‚ Ğ¾ÑÑ‚Ğ°Ñ‚ĞºĞ¾Ğ² Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ\n';
  message += 'â€¢ Ğ¢Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ°Ñ€Ñ‚Ğ¸Ğ¹\n';
  
  SpreadsheetApp.getUi().alert(message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞšĞĞĞ¤Ğ˜Ğ“Ğ£Ğ ĞĞ¦Ğ˜Ğ¯ ĞœĞĞ”Ğ£Ğ›Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ ĞĞ¢Ğš Ğ¸ Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 * Ğ’ĞĞ–ĞĞ: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ²Ğ¼ĞµÑÑ‚Ğ¾ ĞºĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹ Ğ´Ğ»Ñ Ğ¸Ğ·Ğ±ĞµĞ¶Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¾Ğ¹ Config.gs
 */
function getQCFinishedConfig() {
  return {
    SHEETS: {
      // Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ¸
      PRODUCTS_MASTER: MASTER_SHEETS.PRODUCTS,
      EMPLOYEES: MASTER_SHEETS.EMPLOYEES,
      
      // Ğ–ÑƒÑ€Ğ½Ğ°Ğ»Ñ‹ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹
      QC_JOURNAL: 'Ğ–ÑƒÑ€Ğ½Ğ°Ğ»_ĞĞ¢Ğš_Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ°Ñ_ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ñ',
      WAREHOUSE: JOURNAL_SHEETS.WAREHOUSE_FINISHED,
      
      // Ğ‘Ğ°Ğ»Ğ°Ğ½ÑÑ‹
      BALANCE: BALANCE_SHEETS.FINISHED_GOODS
    }
  };
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ ĞĞ—Ğ”Ğ•Ğ› 1: Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ¯ Ğ”ĞĞĞĞ«Ğ¥ Ğ”Ğ›Ğ¯ Ğ¤ĞĞ Ğœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµÑ€Ğ¾Ğ² ĞĞ¢Ğš Ğ¸Ğ· ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ²
 */
function getQCInspectors() {
  try {
    Logger.log('=== getQCInspectors: START ===');
    
    var config = getQCFinishedConfig();
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(config.SHEETS.EMPLOYEES);
    
    if (!sheet) {
      Logger.log('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      return [];
    }
    
    var data = sheet.getDataRange().getValues();
    var inspectors = [];
    
    // Ğ˜Ñ‰ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸
    var headers = data[0];
    var nameCol = -1;
    var departmentCol = -1;
    var statusCol = -1;
    
    for (var i = 0; i < headers.length; i++) {
      if (headers[i] === 'Ğ¤Ğ˜Ğ') nameCol = i;
      if (headers[i] === 'Ğ¦ĞµÑ…') departmentCol = i;
      if (headers[i] === 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ') statusCol = i;
    }
    
    if (nameCol === -1 || departmentCol === -1) {
      Logger.log('ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ñ‹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸ (Ğ¤Ğ˜Ğ, Ğ¦ĞµÑ…)');
      return [];
    }
    
    // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµÑ€Ğ¾Ğ² ĞĞ¢Ğš (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ)
    for (var j = 1; j < data.length; j++) {
      var row = data[j];
      
      if (row[departmentCol] === 'ĞĞ¢Ğš' && 
          (statusCol === -1 || row[statusCol] === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾')) {
        inspectors.push({
          name: row[nameCol],
          department: row[departmentCol]
        });
      }
    }
    
    Logger.log('ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµÑ€Ğ¾Ğ² ĞĞ¢Ğš: ' + inspectors.length);
    Logger.log('=== getQCInspectors: END ===');
    
    return inspectors;
    
  } catch (error) {
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ° getQCInspectors: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
    return [];
  }
}


/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… Ğ·Ğ° Ğ¾Ñ‚Ğ³Ñ€ÑƒĞ·ĞºÑƒ
 * (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ + ĞĞ¢Ğš)
 */
function getShipmentResponsible() {
  try {
    Logger.log('=== getShipmentResponsible: START ===');
    
    var config = getQCFinishedConfig();
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(config.SHEETS.EMPLOYEES);
    
    if (!sheet) {
      Logger.log('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº ÑĞ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¾Ğ² Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      return [];
    }
    
    var data = sheet.getDataRange().getValues();
    var responsible = [];
    
    var headers = data[0];
    var nameCol = -1;
    var departmentCol = -1;
    var statusCol = -1;
    
    for (var i = 0; i < headers.length; i++) {
      if (headers[i] === 'Ğ¤Ğ˜Ğ') nameCol = i;
      if (headers[i] === 'Ğ¦ĞµÑ…') departmentCol = i;
      if (headers[i] === 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ') statusCol = i;
    }
    
    if (nameCol === -1) {
      Logger.log('ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ° ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ° Ğ¤Ğ˜Ğ');
      return [];
    }
    
    // Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ… (ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ¸Ğ»Ğ¸ ĞĞ¢Ğš)
    for (var j = 1; j < data.length; j++) {
      var row = data[j];
      
      if ((departmentCol === -1 || 
           row[departmentCol] === 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ' || 
           row[departmentCol] === 'ĞĞ¢Ğš') && 
          (statusCol === -1 || row[statusCol] === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾')) {
        responsible.push({
          name: row[nameCol]
        });
      }
    }
    
    Logger.log('ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ñ…: ' + responsible.length);
    Logger.log('=== getShipmentResponsible: END ===');
    
    return responsible;
    
  } catch (error) {
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ° getShipmentResponsible: ' + error.toString());
    return [];
  }
}


/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ñ‹Ñ… Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğ¹ Ğ¸Ğ· ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 */
function getFinishedProducts() {
  try {
    Logger.log('=== getFinishedProducts: START ===');
    
    var config = getQCFinishedConfig();
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(config.SHEETS.PRODUCTS_MASTER);
    
    if (!sheet) {
      Logger.log('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      return [];
    }
    
    var data = sheet.getDataRange().getValues();
    var products = [];
    
    Logger.log('Ğ’ÑĞµĞ³Ğ¾ ÑÑ‚Ñ€Ğ¾Ğº Ğ² ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞµ: ' + data.length);
    
    // Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞ° (Ğ¿Ñ€ĞµĞ´Ğ¿Ğ¾Ğ»Ğ°Ğ³Ğ°ĞµĞ¼):
    // A: ĞšĞ¾Ğ´ | B: ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | C: Ğ¢Ğ¸Ğ¿ | D: Ğ“Ñ€ÑƒĞ·Ğ¾Ğ¿Ğ¾Ğ´ÑŠĞµĞ¼Ğ½Ğ¾ÑÑ‚ÑŒ | 
    // E: Ğ Ğ°Ğ·Ğ¼ĞµÑ€Ñ‹ | F: ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ | G: Ğ¦ĞµĞ½Ğ° | H: Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
    
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      
      // Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ Ñ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ¾Ğ´Ğ¾Ğ¼
      if (row[0] && row[7] === 'ĞĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾') {
        products.push({
          code: row[0],
          name: row[1],
          type: row[2],
          capacity: row[3] || 0,
          dimensions: row[4] || '',
          description: row[5] || '',
          price: row[6] || 0,
          displayName: row[0] + ' - ' + row[1]
        });
        
        Logger.log('Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğµ: ' + row[0] + ' - ' + row[1]);
      }
    }
    
    Logger.log('ĞĞ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğ¹: ' + products.length);
    Logger.log('=== getFinishedProducts: END ===');
    
    return products;
    
  } catch (error) {
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ° getFinishedProducts: ' + error.toString());
    Logger.log('Stack: ' + error.stack);
    return [];
  }
}


/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ
 */
function getFinishedProductByCode(code) {
  try {
    Logger.log('=== getFinishedProductByCode: START ===');
    Logger.log('Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼: ' + code);
    
    var config = getQCFinishedConfig();
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(config.SHEETS.PRODUCTS_MASTER);
    
    if (!sheet) {
      Logger.log('Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½');
      return null;
    }
    
    var data = sheet.getDataRange().getValues();
    
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] === code) {
        var product = {
          code: data[i][0],
          name: data[i][1],
          type: data[i][2],
          capacity: data[i][3] || 0,
          dimensions: data[i][4] || '',
          description: data[i][5] || '',
          price: data[i][6] || 0,
          status: data[i][7]
        };
        
        Logger.log('Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾: ' + product.name);
        Logger.log('=== getFinishedProductByCode: END ===');
        
        return product;
      }
    }
    
    Logger.log('Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ Ñ ĞºĞ¾Ğ´Ğ¾Ğ¼ ' + code + ' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾');
    Logger.log('=== getFinishedProductByCode: END ===');
    return null;
    
  } catch (error) {
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ° getFinishedProductByCode: ' + error.toString());
    return null;
  }
}


/**
 * ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ ĞºĞ¾Ğ´Ñƒ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ
 */
function getProductBalance(productCode) {
  Logger.log('=== getProductBalance START ===');
  Logger.log('productCode = "' + productCode + '"');
  
  var config = getQCFinishedConfig();
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName(config.SHEETS.BALANCE);
  
  if (!sheet) {
    Logger.log('Sheet not found');
    return 0;
  }
  
  var data = sheet.getDataRange().getValues();
  Logger.log('Total rows: ' + data.length);
  Logger.log('Row 2: code="' + data[1][0] + '", balance=' + data[1][5]);
  
  for (var i = 1; i < data.length; i++) {
    if (data[i][0] === productCode) {
      Logger.log('MATCH at row ' + i);
      return parseFloat(data[i][5]) || 0;
    }
  }
  
  Logger.log('NO MATCH FOUND');
  return 0;
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ ĞĞ—Ğ”Ğ•Ğ› 2: ĞĞ¡ĞĞĞ’ĞĞ«Ğ• Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ ĞĞ‘Ğ ĞĞ‘ĞĞ¢ĞšĞ˜ Ğ”ĞĞĞĞ«Ğ¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ĞŸÑ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ĞµĞ¼ĞºĞ¸ ĞĞ¢Ğš Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸
 * 
 * @param {Object} formData - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¿Ñ€Ğ¸ĞµĞ¼ĞºĞ¸
 * @return {Object} Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ {success: boolean, message: string, docNumber: string}
 */
function processQCAcceptance(formData) {
  try {
    Logger.log('=== processQCAcceptance: START ===');
    Logger.log('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹: ' + JSON.stringify(formData));
    
    var config = getQCFinishedConfig();
    
    // ========================================
    // Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ¯ Ğ’Ğ¥ĞĞ”ĞĞ«Ğ¥ Ğ”ĞĞĞĞ«Ğ¥
    // ========================================
    
    if (!formData.date) {
      return {
        success: false,
        message: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° Ğ´Ğ°Ñ‚Ğ°!'
      };
    }
    
    if (!formData.inspector) {
      return {
        success: false,
        message: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµÑ€ ĞĞ¢Ğš!'
      };
    }
    
    if (!formData.productCode) {
      return {
        success: false,
        message: 'ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğµ!'
      };
    }
    
    if (!formData.quantityGood || formData.quantityGood <= 0) {
      return {
        success: false,
        message: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ³Ğ¾Ğ´Ğ½Ñ‹Ñ… Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0!'
      };
    }
    
    // ========================================
    // ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ Ğ˜Ğ—Ğ”Ğ•Ğ›Ğ˜Ğ¯
    // ========================================
    
    var product = getFinishedProductByCode(formData.productCode);
    
    if (!product) {
      return {
        success: false,
        message: 'Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ ' + formData.productCode + ' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ² ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞµ!'
      };
    }
    
    // ========================================
    // ĞŸĞĞ”Ğ“ĞĞ¢ĞĞ’ĞšĞ Ğ”ĞĞĞĞ«Ğ¥
    // ========================================
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    var quantityGood = parseFloat(formData.quantityGood) || 0;
    var quantityDefect = parseFloat(formData.quantityDefect) || 0;
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ DD.MM.YYYY
    var dateParts = formData.date.split('-');
    var dateString = dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0];
    
    var now = new Date();
    var timeStr = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');
    
    // ========================================
    // 1. Ğ—ĞĞŸĞ˜Ğ¡Ğ¬ Ğ’ Ğ–Ğ£Ğ ĞĞĞ› ĞĞ¢Ğš
    // ========================================
    
    var journalSheet = ss.getSheetByName(config.SHEETS.QC_JOURNAL);
    
    if (!journalSheet) {
      return {
        success: false,
        message: 'Ğ–ÑƒÑ€Ğ½Ğ°Ğ» ĞĞ¢Ğš Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!'
      };
    }
    
    var lastRow = journalSheet.getLastRow();
    var targetRow = lastRow + 1;
    var docNumber = 'QC-' + String(targetRow - 1).padStart(5, '0');
    
    // Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¶ÑƒÑ€Ğ½Ğ°Ğ»Ğ° ĞĞ¢Ğš:
    // A: ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° | B: Ğ”Ğ°Ñ‚Ğ° | C: Ğ’Ñ€ĞµĞ¼Ñ | D: ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ĞµÑ€ | E: ĞšĞ¾Ğ´ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ |
    // F: ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | G: Ğ¢Ğ¸Ğ¿ | H: Ğ“Ğ¾Ğ´Ğ½Ñ‹Ñ… | I: Ğ‘Ñ€Ğ°Ğº | J: ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ±Ñ€Ğ°ĞºĞ° |
    // K: ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ | L: Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
    
    journalSheet.getRange(targetRow, 1).setValue(docNumber);                  // A
    journalSheet.getRange(targetRow, 2).setValue(dateString);                 // B
    journalSheet.getRange(targetRow, 3).setValue(timeStr);                    // C
    journalSheet.getRange(targetRow, 4).setValue(formData.inspector);         // D
    journalSheet.getRange(targetRow, 5).setValue(product.code);               // E
    journalSheet.getRange(targetRow, 6).setValue(product.name);               // F
    journalSheet.getRange(targetRow, 7).setValue(product.type);               // G
    journalSheet.getRange(targetRow, 8).setValue(quantityGood);               // H
    journalSheet.getRange(targetRow, 9).setValue(quantityDefect);             // I
    journalSheet.getRange(targetRow, 10).setValue(formData.defectReason || ''); // J
    journalSheet.getRange(targetRow, 11).setValue(formData.notes || '');      // K
    journalSheet.getRange(targetRow, 12).setValue(STATUSES.COMPLETED);        // L
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    journalSheet.getRange(targetRow, 2).setNumberFormat('dd.mm.yyyy');
    journalSheet.getRange(targetRow, 8).setNumberFormat('0" ÑˆÑ‚"');
    journalSheet.getRange(targetRow, 9).setNumberFormat('0" ÑˆÑ‚"');
    
    Logger.log('Ğ—Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ Ğ² Ğ¶ÑƒÑ€Ğ½Ğ°Ğ» ĞĞ¢Ğš: ' + docNumber);
    
    // ========================================
    // 2. ĞĞŸĞ Ğ˜Ğ¥ĞĞ”ĞĞ’ĞĞĞ˜Ğ• ĞĞ Ğ¡ĞšĞ›ĞĞ” Ğ“ĞĞ¢ĞĞ’ĞĞ™ ĞŸĞ ĞĞ”Ğ£ĞšĞ¦Ğ˜Ğ˜
    // ========================================
    
    var warehouseSheet = ss.getSheetByName(config.SHEETS.WAREHOUSE);
    
    if (!warehouseSheet) {
      return {
        success: false,
        message: 'Ğ¡ĞºĞ»Ğ°Ğ´ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!'
      };
    }
    
    var whLastRow = warehouseSheet.getLastRow();
    var whTargetRow = whLastRow + 1;
    var whDocNumber = 'WH-FP-' + String(whTargetRow - 1).padStart(5, '0');
    
    // Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑĞºĞ»Ğ°Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸:
    // A: ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° | B: Ğ”Ğ°Ñ‚Ğ° | C: Ğ’Ñ€ĞµĞ¼Ñ | D: Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ | E: ĞšĞ¾Ğ´ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ |
    // F: ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | G: Ğ¢Ğ¸Ğ¿ | H: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | I: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ |
    // J: ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒ | K: ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ | L: Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
    
    warehouseSheet.getRange(whTargetRow, 1).setValue(whDocNumber);            // A
    warehouseSheet.getRange(whTargetRow, 2).setValue(dateString);             // B
    warehouseSheet.getRange(whTargetRow, 3).setValue(timeStr);                // C
    warehouseSheet.getRange(whTargetRow, 4).setValue(OPERATION_TYPES.RECEIPT); // D
    warehouseSheet.getRange(whTargetRow, 5).setValue(product.code);           // E
    warehouseSheet.getRange(whTargetRow, 6).setValue(product.name);           // F
    warehouseSheet.getRange(whTargetRow, 7).setValue(product.type);           // G
    warehouseSheet.getRange(whTargetRow, 8).setValue(quantityGood);           // H
    warehouseSheet.getRange(whTargetRow, 9).setValue(docNumber);              // I
    warehouseSheet.getRange(whTargetRow, 10).setValue('ĞĞ¢Ğš');                 // J
    warehouseSheet.getRange(whTargetRow, 11).setValue(formData.notes || '');  // K
    warehouseSheet.getRange(whTargetRow, 12).setValue(STATUSES.COMPLETED);    // L
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    warehouseSheet.getRange(whTargetRow, 2).setNumberFormat('dd.mm.yyyy');
    warehouseSheet.getRange(whTargetRow, 8).setNumberFormat('0" ÑˆÑ‚"');
    
    Logger.log('ĞĞ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´: ' + whDocNumber);
    
    // ========================================
    // ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ™ ĞŸĞ•Ğ Ğ•Ğ¡Ğ§Ğ•Ğ¢
    // ========================================
    
    SpreadsheetApp.flush();
    
    // ========================================
    // Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ•
    // ========================================
    
    var message = 'ĞŸÑ€Ğ¸ĞµĞ¼ĞºĞ° ĞĞ¢Ğš ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ°!\n\n';
    message += 'Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚: ' + docNumber + '\n';
    message += 'Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ: ' + product.code + ' - ' + product.name + '\n';
    message += 'Ğ“Ğ¾Ğ´Ğ½Ñ‹Ñ…: ' + quantityGood + ' ÑˆÑ‚\n';
    
    if (quantityDefect > 0) {
      message += 'Ğ‘Ñ€Ğ°Ğº: ' + quantityDefect + ' ÑˆÑ‚\n';
      if (formData.defectReason) {
        message += 'ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° Ğ±Ñ€Ğ°ĞºĞ°: ' + formData.defectReason + '\n';
      }
    }
    
    message += '\nĞĞ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´Ğ¾Ğ²Ğ°Ğ½Ğ¾ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´: ' + whDocNumber;
    
    Logger.log('ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');
    Logger.log('=== processQCAcceptance: END ===');
    
    return {
      success: true,
      message: message,
      docNumber: docNumber
    };
    
  } catch (error) {
    Logger.log('ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² processQCAcceptance');
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.toString());
    Logger.log('Stack trace: ' + error.stack);
    Logger.log('=== processQCAcceptance: END WITH ERROR ===');
    
    return {
      success: false,
      message: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ' + error.message + '\n\nĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Apps Script â†’ Executions Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹'
    };
  }
}


/**
 * ĞŸÑ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»Ñ
 * 
 * @param {Object} formData - Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹ Ğ¾Ñ‚Ğ³Ñ€ÑƒĞ·ĞºĞ¸
 * @return {Object} Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ {success: boolean, message: string, docNumber: string}
 */
function processProductShipment(formData) {
  try {
    Logger.log('=== processProductShipment: START ===');
    Logger.log('Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñ‹: ' + JSON.stringify(formData));
    
    var config = getQCFinishedConfig();
    
    // ========================================
    // Ğ’ĞĞ›Ğ˜Ğ”ĞĞ¦Ğ˜Ğ¯ Ğ’Ğ¥ĞĞ”ĞĞ«Ğ¥ Ğ”ĞĞĞĞ«Ğ¥
    // ========================================
    
    if (!formData.date) {
      return {
        success: false,
        message: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ° Ğ´Ğ°Ñ‚Ğ°!'
      };
    }
    
    if (!formData.customer) {
      return {
        success: false,
        message: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ¿Ğ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ!'
      };
    }
    
    if (!formData.productCode) {
      return {
        success: false,
        message: 'ĞĞµ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ¾ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ğµ!'
      };
    }
    
    if (!formData.quantity || formData.quantity <= 0) {
      return {
        success: false,
        message: 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ñ‚ÑŒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ 0!'
      };
    }
    
    if (!formData.responsible) {
      return {
        success: false,
        message: 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½ Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹!'
      };
    }
    
    // ========================================
    // ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ĞĞ¡Ğ¢ĞĞ¢ĞšĞĞ’ ĞĞ Ğ¡ĞšĞ›ĞĞ”Ğ•
    // ========================================
    
    var balance = getProductBalance(formData.productCode);
    var quantity = parseFloat(formData.quantity);
    
    if (quantity > balance) {
      return {
        success: false,
        message: 'ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ!\n\n' +
                 'Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ¾: ' + quantity + ' ÑˆÑ‚\n' +
                 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾: ' + balance + ' ÑˆÑ‚\n' +
                 'ĞĞµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚: ' + (quantity - balance) + ' ÑˆÑ‚'
      };
    }
    
    // ========================================
    // ĞŸĞĞ›Ğ£Ğ§Ğ•ĞĞ˜Ğ• Ğ”ĞĞĞĞ«Ğ¥ Ğ˜Ğ—Ğ”Ğ•Ğ›Ğ˜Ğ¯
    // ========================================
    
    var product = getFinishedProductByCode(formData.productCode);
    
    if (!product) {
      return {
        success: false,
        message: 'Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ ' + formData.productCode + ' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ Ğ² ÑĞ¿Ñ€Ğ°Ğ²Ğ¾Ñ‡Ğ½Ğ¸ĞºĞµ!'
      };
    }
    
    // ========================================
    // Ğ¡ĞŸĞ˜Ğ¡ĞĞĞ˜Ğ• Ğ¡Ğ Ğ¡ĞšĞ›ĞĞ”Ğ Ğ“ĞĞ¢ĞĞ’ĞĞ™ ĞŸĞ ĞĞ”Ğ£ĞšĞ¦Ğ˜Ğ˜
    // ========================================
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var warehouseSheet = ss.getSheetByName(config.SHEETS.WAREHOUSE);
    
    if (!warehouseSheet) {
      return {
        success: false,
        message: 'Ğ¡ĞºĞ»Ğ°Ğ´ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½!'
      };
    }
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ°Ñ‚Ñƒ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ DD.MM.YYYY
    var dateParts = formData.date.split('-');
    var dateString = dateParts[2] + '.' + dateParts[1] + '.' + dateParts[0];
    
    var now = new Date();
    var timeStr = Utilities.formatDate(now, Session.getScriptTimeZone(), 'HH:mm:ss');
    
    var lastRow = warehouseSheet.getLastRow();
    var targetRow = lastRow + 1;
    var docNumber = 'SHIP-' + String(targetRow - 1).padStart(5, '0');
    
    // Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° ÑĞºĞ»Ğ°Ğ´Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ´ÑƒĞºÑ†Ğ¸Ğ¸ (Ñ€Ğ°ÑÑ…Ğ¾Ğ´):
    // A: ĞĞ¾Ğ¼ĞµÑ€ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° | B: Ğ”Ğ°Ñ‚Ğ° | C: Ğ’Ñ€ĞµĞ¼Ñ | D: Ğ¢Ğ¸Ğ¿ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ | E: ĞšĞ¾Ğ´ Ğ¸Ğ·Ğ´ĞµĞ»Ğ¸Ñ |
    // F: ĞĞ°Ğ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ | G: Ğ¢Ğ¸Ğ¿ | H: ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ | I: Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ¢Ğ¢Ğ) |
    // J: ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°Ñ‚ĞµĞ»ÑŒ | K: ĞŸÑ€Ğ¸Ğ¼ĞµÑ‡Ğ°Ğ½Ğ¸Ğµ | L: Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ
    
    warehouseSheet.getRange(targetRow, 1).setValue(docNumber);                  // A
    warehouseSheet.getRange(targetRow, 2).setValue(dateString);                 // B
    warehouseSheet.getRange(targetRow, 3).setValue(timeStr);                    // C
    warehouseSheet.getRange(targetRow, 4).setValue(OPERATION_TYPES.EXPENSE);    // D
    warehouseSheet.getRange(targetRow, 5).setValue(product.code);               // E
    warehouseSheet.getRange(targetRow, 6).setValue(product.name);               // F
    warehouseSheet.getRange(targetRow, 7).setValue(product.type);               // G
    warehouseSheet.getRange(targetRow, 8).setValue(quantity);                   // H
    warehouseSheet.getRange(targetRow, 9).setValue(formData.ttnNumber || '');   // I
    warehouseSheet.getRange(targetRow, 10).setValue(formData.customer);         // J
    warehouseSheet.getRange(targetRow, 11).setValue(formData.notes || '');      // K
    warehouseSheet.getRange(targetRow, 12).setValue(STATUSES.COMPLETED);        // L
    
    // Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    warehouseSheet.getRange(targetRow, 2).setNumberFormat('dd.mm.yyyy');
    warehouseSheet.getRange(targetRow, 8).setNumberFormat('0" ÑˆÑ‚"');
    
    Logger.log('Ğ¡Ğ¿Ğ¸ÑĞ°Ğ½Ğ¾ ÑĞ¾ ÑĞºĞ»Ğ°Ğ´Ğ°: ' + docNumber);
    
    // ========================================
    // ĞŸĞ Ğ˜ĞĞ£Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞ«Ğ™ ĞŸĞ•Ğ Ğ•Ğ¡Ğ§Ğ•Ğ¢
    // ========================================
    
    SpreadsheetApp.flush();
    
    // ========================================
    // Ğ¤ĞĞ ĞœĞ˜Ğ Ğ£Ğ•Ğœ Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ•
    // ========================================
    
    var newBalance = balance - quantity;
    
    var message = 'ĞÑ‚Ğ³Ñ€ÑƒĞ·ĞºĞ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ°!\n\n';
    message += 'Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚: ' + docNumber + '\n';
    message += 'ĞŸĞ¾ĞºÑƒĞ¿Ğ°Ñ‚ĞµĞ»ÑŒ: ' + formData.customer + '\n';
    message += 'Ğ˜Ğ·Ğ´ĞµĞ»Ğ¸Ğµ: ' + product.code + ' - ' + product.name + '\n';
    message += 'ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾: ' + quantity + ' ÑˆÑ‚\n';
    
    if (formData.ttnNumber) {
      message += 'Ğ¢Ğ¢Ğ: ' + formData.ttnNumber + '\n';
    }
    
    message += '\nĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ: ' + newBalance + ' ÑˆÑ‚';
    
    if (newBalance === 0) {
      message += '\n\nâš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: Ğ¢Ğ¾Ğ²Ğ°Ñ€ Ğ·Ğ°ĞºĞ¾Ğ½Ñ‡Ğ¸Ğ»ÑÑ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğµ!';
    } else if (newBalance < 10) {
      message += '\n\nâš ï¸ Ğ’ĞĞ˜ĞœĞĞĞ˜Ğ•: ĞœĞ°Ğ»Ñ‹Ğ¹ Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ğº!';
    }
    
    Logger.log('ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾');
    Logger.log('=== processProductShipment: END ===');
    
    return {
      success: true,
      message: message,
      docNumber: docNumber
    };
    
  } catch (error) {
    Logger.log('ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° Ğ² processProductShipment');
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.toString());
    Logger.log('Stack trace: ' + error.stack);
    Logger.log('=== processProductShipment: END WITH ERROR ===');
    
    return {
      success: false,
      message: 'Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: ' + error.message + '\n\nĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ Apps Script â†’ Executions Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ĞµĞ¹'
    };
  }
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ ĞĞ—Ğ”Ğ•Ğ› 3: Ğ¤Ğ£ĞĞšĞ¦Ğ˜Ğ˜ Ğ”Ğ›Ğ¯ UI (ĞŸĞĞšĞĞ— Ğ¡ĞĞĞ‘Ğ©Ğ•ĞĞ˜Ğ™)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

/**
 * ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞĞ¢Ğš Ğ² UI Google Sheets
 */
function showQCMessage(message) {
  SpreadsheetApp.getUi().alert(message);
}

/**
 * ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ğ² UI Google Sheets
 */
function showShipmentMessage(message) {
  SpreadsheetApp.getUi().alert(message);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞšĞĞĞ•Ğ¦ ĞœĞĞ”Ğ£Ğ›Ğ¯ ĞĞ¢Ğš Ğ˜ Ğ“ĞĞ¢ĞĞ’ĞĞ¯ ĞŸĞ ĞĞ”Ğ£ĞšĞ¦Ğ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•